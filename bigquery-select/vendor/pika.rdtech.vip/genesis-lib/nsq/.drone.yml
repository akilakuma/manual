workspace:
  base: /go
  path: src/${DRONE_REPO_NAME}

kind: pipeline
name: lib
clone:
  skip_verify: true

services:
- name: nsqlookupd
  image: nsqio/nsq
  command: ["/nsqlookupd"]
  ports: [4160,4161]

- name: nsqd
  image: nsqio/nsq
  command: ["/nsqd", "--lookupd-tcp-address=nsqlookupd:4160"]
  depends_on:
  - nsqlookupd
  ports: [4150,4151]

- name: nsqadmin
  image: nsqio/nsq
  command: ["/nsqadmin", "--lookupd-http-address=nsqlookupd:4161"]
  depends_on:
  - nsqlookupd
  - nsqd
  ports: [4171]

steps:
- name: "ping nsq"
  image: curlimages/curl:7.71.1
  commands:
    - sleep 5
    - curl nsqd:4151/ping
    - curl nsqlookupd:4161/ping
    - curl nsqadmin:4171/ping

- name: golang_test
  image: golang:1.13
  environment:
    CGO_ENABLED: 0
    GO111MODULE: on
    ENV: "go_test"
  commands:
    - sleep 5
    - go get -u --insecure ./...
    - go test -cover